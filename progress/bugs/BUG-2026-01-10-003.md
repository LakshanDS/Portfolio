# BUG-2026-01-10-003: Status/Category Type Narrowing Required

**Bug ID**: BUG-2026-01-10-003
**Severity**: Critical (Build Blocking)
**Status**: Open
**Date Reported**: 2026-01-10
**Priority**: High

---

## Summary

Prisma returns `string` type for status and category fields, but TypeScript interfaces expect specific union types (e.g., `"live" | "developing" | "archived"`). This causes type incompatibility errors across multiple files.

---

## Affected Files

### 1. Roadmap Pages
**Files**:
- [src/app/roadmap/page.tsx](file:///d:/Projects/Portfolio/src/app/roadmap/page.tsx#L52)
- [src/app/page.tsx](file:///d:/Projects/Portfolio/src/app/page.tsx#L185)
- [src/app/jasladmin/(dashboard)/roadmap/page.tsx](file:///d:/Projects/Portfolio/src/app/jasladmin/(dashboard)/roadmap/page.tsx#L41)

**Expected Types**:
```typescript
status: "completed" | "in-progress" | "planned"
category: "devops" | "career" | "learning" | "goals"
```

**Actual Types from Prisma**:
```typescript
status: string  // Too broad
category: string  // Too broad
```

**Error Example**:
```typescript
// Line 52 in src/app/roadmap/page.tsx
const roadmapItems: RoadmapItem[] = await getRoadmapItems();
// Error: Type 'string' is not assignable to type '"completed" | "in-progress" | "planned"'
```

### 2. Project Pages
**Files**:
- [src/app/projects/page.tsx](file:///d:/Projects/Portfolio/src/app/projects/page.tsx#L24)
- [src/app/jasladmin/(dashboard)/projects/page.tsx](file:///d:/Projects/Portfolio/src/app/jasladmin/(dashboard)/projects/page.tsx#L33)

**Expected Type**:
```typescript
status: "live" | "developing" | "archived"
```

**Actual Type from Prisma**:
```typescript
status: string
```

**Error Example**:
```typescript
// Line 24 in src/app/projects/page.tsx
const projects: Project[] = await getProjects();
// Error: Type 'string' is not assignable to type '"live" | "developing" | "archived"'
```

---

## Database Schema Definition

### Prisma Schema (uses `String` type):
```prisma
model Project {
  status String
}

model RoadmapItem {
  status String
  category String
}
```

### TypeScript Interface (expects union types):
```typescript
export interface Project {
  status: 'live' | 'developing' | 'archived';
}

export interface RoadmapItem {
  status: 'completed' | 'in-progress' | 'planned';
  category: 'devops' | 'career' | 'learning' | 'goals';
}
```

---

## Root Cause

1. Prisma schema defines fields as `String` type (generic)
2. Prisma generates TypeScript types as `string` (not union types)
3. Application interfaces expect specific union types for type safety
4. Data layer functions don't perform type narrowing
5. TypeScript sees `string` (from Prisma) vs `"live" | "developing" | "archived"` (interface) as incompatible

---

## Error Messages

```
Type '{ id: string; ...; status: string; ... }[]' is not assignable to type 'Project[]'.
  Types of property 'status' are incompatible.
    Type 'string' is not assignable to type '"live" | "developing" | "archived"'.
```

```
Type 'string' is not assignable to type '"completed" | "in-progress" | "planned"'.
```

---

## Proposed Fix

### Option 1: Add Type Narrowing in Data Layer (Recommended)

Update all data retrieval functions in [src/lib/data.ts](file:///d:/Projects/Portfolio/src/lib/data.ts) to perform type narrowing:

```typescript
// Update getProjects() function:
export async function getProjects() {
  const projects = await prisma.project.findMany({
    orderBy: { createdAt: 'desc' }
  });

  return projects.map(p => ({
    ...p,
    tags: JSON.parse(p.tags),
    status: p.status as 'live' | 'developing' | 'archived'
  }));
}

// Update getProject() function:
export async function getProject(id: string) {
  const project = await prisma.project.findUnique({
    where: { id }
  });

  if (!project) return null;

  return {
    ...project,
    tags: JSON.parse(project.tags),
    status: project.status as 'live' | 'developing' | 'archived'
  };
}

// Update getRoadmapItems() function:
export async function getRoadmapItems() {
  const items = await prisma.roadmapItem.findMany({
    orderBy: { date: 'desc' }
  });

  return items.map(r => ({
    ...r,
    tags: JSON.parse(r.tags),
    status: r.status as 'completed' | 'in-progress' | 'planned',
    category: r.category as 'devops' | 'career' | 'learning' | 'goals'
  }));
}

// Update getRoadmapItem() function:
export async function getRoadmapItem(id: string) {
  const item = await prisma.roadmapItem.findUnique({
    where: { id }
  });

  if (!item) return null;

  return {
    ...item,
    tags: JSON.parse(item.tags),
    status: item.status as 'completed' | 'in-progress' | 'planned',
    category: item.category as 'devops' | 'career' | 'learning' | 'goals'
  });
}
```

### Option 2: Use Prisma Enums (More Robust)

Update Prisma schema to use enums:

```prisma
// In prisma/schema.prisma
enum ProjectStatus {
  live
  developing
  archived
}

enum RoadmapStatus {
  completed
  in_progress
  planned
}

enum RoadmapCategory {
  devops
  career
  learning
  goals
}

model Project {
  status ProjectStatus @default(developing)
}

model RoadmapItem {
  status RoadmapStatus @default(planned)
  category RoadmapCategory
}
```

This requires:
1. Schema update
2. Database migration
3. Regenerating Prisma client
4. Removing manual type narrowing from data layer

---

## Validation Functions (Recommended Addition)

Add validation functions in [src/lib/data.ts](file:///d:/Projects/Portfolio/src/lib/data.ts) to ensure runtime type safety:

```typescript
function isValidProjectStatus(status: string): status is 'live' | 'developing' | 'archived' {
  return ['live', 'developing', 'archived'].includes(status);
}

function isValidRoadmapStatus(status: string): status is 'completed' | 'in-progress' | 'planned' {
  return ['completed', 'in-progress', 'planned'].includes(status);
}

function isValidRoadmapCategory(category: string): category is 'devops' | 'career' | 'learning' | 'goals' {
  return ['devops', 'career', 'learning', 'goals'].includes(category);
}
```

---

## Impact

- **Build Status**: BLOCKED - ~15 TypeScript errors
- **Type Safety**: Compromised - Union type constraints not enforced
- **Runtime Safety**: Potential - Invalid values could pass through

---

## Blocks

- Build process
- TypeScript compilation
- Production deployment

---

## Verification Steps

1. Apply type narrowing to all affected functions in data.ts
2. Run: `npx tsc --noEmit`
3. Verify no type incompatibility errors
4. Test all CRUD operations
5. Verify enum values are enforced at runtime

---

## Related Issues

- BUG-2026-01-10-001 (Resume API Route Type Mismatch)
- BUG-2026-01-10-002 (Field Name Inconsistencies)

---

## References

- [prisma/schema.prisma](file:///d:/Projects/Portfolio/prisma/schema.prisma) - Schema definition
- [src/lib/data.ts](file:///d:/Projects/Portfolio/src/lib/data.ts) - Data layer functions
- [src/lib/types.ts](file:///d:/Projects/Portfolio/src/lib/types.ts) - TypeScript interfaces

---

**Assigned To**: Unassigned
**Estimated Fix Time**: 20-30 minutes
**Actual Fix Time**: TBD
